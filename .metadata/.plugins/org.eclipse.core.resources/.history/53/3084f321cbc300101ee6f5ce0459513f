package com.flightapp.service.implimentation;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.flightapp.dto.BookingRequest;
import com.flightapp.dto.CancelResponse;
import com.flightapp.dto.ItineraryDto;
import com.flightapp.dto.TripType;
import com.flightapp.entity.Booking;
import com.flightapp.entity.BookingStatus;
import com.flightapp.entity.Flight;
import com.flightapp.entity.FlightStatus;
import com.flightapp.entity.Itinerary;
import com.flightapp.entity.Role;
import com.flightapp.entity.TripSegmentType;
import com.flightapp.entity.User;
import com.flightapp.exception.ResourceNotFoundException;
import com.flightapp.exception.SeatNotAvailableException;
import com.flightapp.repository.BookingRepository;
import com.flightapp.repository.FlightRepository;
import com.flightapp.repository.ItineraryRepository;
import com.flightapp.repository.PassengerRepository;
import com.flightapp.repository.UserRepository;
import com.flightapp.service.BookingService;

import lombok.extern.slf4j.Slf4j;

@Service
@Slf4j
public class BookingServiceImpl implements BookingService{
	private final UserRepository userRepository;
	private final FlightRepository flightRepository;
	private final ItineraryRepository itineraryRepository;
	private final BookingRepository bookingRepository;
	private final PassengerRepository passengerRepository;
	
	public BookingServiceImpl(UserRepository userRepository, FlightRepository flightRepository,
			ItineraryRepository itineraryRepository, BookingRepository bookingRepository,
			PassengerRepository passengerRepository) {
		super();
		this.userRepository = userRepository;
		this.flightRepository = flightRepository;
		this.itineraryRepository = itineraryRepository;
		this.bookingRepository = bookingRepository;
		this.passengerRepository = passengerRepository;
	}

	@Override
	public ItineraryDto bookItinerary(int outwardFlightId, BookingRequest req) {
		log.info("Booking initireary for email={} tripType={} outwardFlight={}", req.getEmail(), req.getTripType(), outwardFlightId);
		
		validateBookingReq(req);
		
		User user = getOrCreateUser(req.getName(), req.getEmail());
		
		Flight outwardFlight = getFlightOrThrow(outwardFlightId);
		Flight returnFlight = null;
		boolean isRoundTrip = req.getTripType()==TripType.ROUND_TRIP;
		
		if(isRoundTrip) {
			if(req.getReturnFlightId()==null) {
				throw new IllegalArgumentException("Return FlightId required!!!");
			}
			returnFlight = getFlightOrThrow(req.getReturnFlightId());
		}
		
		List<String> requestedSeats = req.getPassengers().stream()
				.map(passengerReq -> passengerReq.getSeatNumber())
				.toList();
		
		validateFLightSeats(outwardFlight, requestedSeats, req.getNumberOfSeats());
		
		if(isRoundTrip) validateFLightSeats(returnFlight, requestedSeats, req.getNumberOfSeats());
		
		int seats = req.getNumberOfSeats();
		int outwardAmount = outwardFlight.getPrice()*seats;
		int returnAmount = isRoundTrip?(returnFlight.getPrice()*seats):0;
		
		int totalAmount = outwardAmount+returnAmount;
		
		Itinerary i = new Itinerary();
		i.setPnr(generatePnr());
		i.setUser(user);
		i.setCreatedTime(LocalDateTime.now());
		i.setTotalAmount(totalAmount);
		i.setStatus(BookingStatus.BOOKED);
		
		List<Booking> bookings = new ArrayList();
		
		Booking outwardBooking = createBookingLeg(i,outwardFlight, req, isRoundTrip?TripSegmentType.OUTBOUND:TripSegmentType.ONE_WAY);
		bookings.add(outwardBooking);			
		if(isRoundTrip && returnFlight!=null) {
			Booking returnBooking = createBookingLeg(i,returnFlight, req, TripSegmentType.RETURN);
			bookings.add(returnBooking);			
		}
		i.setBookings(bookings);
		
		itineraryRepository.save(i);
		
		log.info("Itinerary added successfully with PNR={} for user={}", i.getPnr(), user.getName());
		
		return toItineraryDto(i);
	}

	


	private void validateBookingReq(BookingRequest req) {
		if(req.getPassengers()==null) {
			throw new IllegalArgumentException("Add Atleast one exception!!!");
		}
		if(req.getNumberOfSeats()==0) {
			throw new IllegalArgumentException("No Seats available!!!");
		}
		if(req.getPassengers().size()!=req.getNumberOfSeats()) {
			throw new IllegalArgumentException("Number of seats != number of passengers!!!");
		}
	}
	private User getOrCreateUser(String name, String email) {
		return userRepository.findByEmail(email).orElseGet(()->{
			log.info("User Not found for email={}, hence CREATING NEW USER", email);
			User u = new User();
			u.setName(name);
			u.setEmail(email);
			u.setRole(Role.USER);
			return userRepository.save(u);
		});
	}
	private Flight getFlightOrThrow(int outwardFlightId) {
		return flightRepository.findById(outwardFlightId).orElseThrow(()-> new ResourceNotFoundException("Flight not found for id={}",outwardFlightId));
	}
	
	private void validateFLightSeats(Flight outwardFlight, List<String> requestedSeats, int numberOfSeats) {
		if(outwardFlight.getStatus() != FlightStatus.SCHEDULED) {
			throw new IllegalArgumentException("Flight with id={} is not scheduled!!!"+outwardFlight.getId());
		}
		if (outwardFlight.getAvailableSeats() < numberOfSeats) {
            throw new SeatNotAvailableException("Not enough seats available on flight " + outwardFlight.getId());
        }
		
		List<String> takenSeats = passengerRepository.findTakenSeatNumbers(outwardFlight.getId(), requestedSeats);
		if(takenSeats.isEmpty()) {
			log.warn("Seat Conflict on flight={}, for seats={}", outwardFlight.getId(), takenSeats);
			throw new SeatNotAvailableException("Seats Allready Taken!!!");
		}
	}

	@Override
	public ItineraryDto getItineraryByPnr(String pnr) {
		log.info("Fetching itinerary by PNR={}",pnr);
		Itinerary i = itineraryRepository.findByPnr(pnr).orElseThrow(()-> new ResourceNotFoundException("No itinerary for pnr!!!"));
		return toItineraryDto(i);
	}


	@Override
	public List<ItineraryDto> getHistoryByEmail(String email) {
		log.info("Fetching booking history for email={}",email);
		List<Itinerary> i = itineraryRepository.findByUserEmail(email);
		
		log.debug("Found {} itineraries", i.size());
		
		return i.stream().toList().map(x -> this.toItineraryDto(x)).toList();
	}

	@Override
	public CancelResponse cancelByPnr(String pnr) {
		// TODO Auto-generated method stub
		return null;
	}
	
	private ItineraryDto toItineraryDto(Itinerary i) {
		// TODO Auto-generated method stub
		return null;
	}
	//Booking Ticket
	
	
	
}
